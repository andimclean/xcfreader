# xcfreader

Parses files generated by GIMP (.xcf) and exposes a small JS API to read metadata, layers and render images.

Highlights

- Native ESM: source files in `src/` use ECMAScript modules; `package.json` sets `type: "module"` and `main` points to `src/gimpparser.js`.
- No Babel build step: edit files in `src/` and run with `node`.
- Examples are in `examples/` and runnable with `npm run single|multi|map|text` (uses `nodemon` for live reload during development).
- Tests live in `tests/` and can be run with `npm test`.

What it does

- Parse a GIMP XCF file and expose image width/height and layer metadata.
- Provide per-layer rendering via a small `XCFImage` wrapper around `pngjs-image`.
- Support RGB/RGBA raster images (indexed/grayscale/text/path support is limited or TODO).

Quick start

Install dependencies:

```bash
npm install
```

Run examples (from the repo root):

```bash
npm run single
npm run multi
npm run map
npm run text
```

Run tests:

```bash
npm test
```

Usage (programmatic)

Import the parser and parse a file:

```js
import { XCFParser } from './src/gimpparser.js';

XCFParser.parseFile('./examples/single.xcf', (err, parser) => {
  if (err) throw err;
  console.log(parser.width, parser.height);
  console.log('layers:', parser.layers.length);
  const image = parser.createImage(); // returns an XCFImage instance with flattened visible layers
  image.writeImage('./examples/output/flattened.png');
});
```

API notes

- `XCFParser.parseFile(path, callback)` — parse an XCF file (callback receives `(err, parser)`).
- `parser.width`, `parser.height` — numeric image dimensions.
- `parser.layers` — array of `GimpLayer` objects. `GimpLayer` exposes `.name`, `.width`, `.height`, `.x`, `.y`, `.isVisible`, `.isGroup`, `.opacity`, and `.parasites`.
- `GimpLayer.makeImage(image?, useOffset?)` — renders the layer into an `XCFImage` instance. If `image` is omitted, returns a new `XCFImage` sized appropriately.
- `parser.createImage()` — returns an `XCFImage` with all visible layers flattened (uses layer offsets).

About `XCFImage`

`XCFImage` is a thin wrapper around `pngjs-image` and implements `setAt(x,y,colour)` and `getAt(x,y)` where `colour` is `{red, green, blue, alpha}`. Example usage and tests expect this contract.

Notes for contributors

- Edit source in `src/` (ES modules). Do not edit `lib/` except to inspect historical compiled output.
- Many parsers are built with `binary-parser`; preserve existing assertions and formatters unless fixing a specific format issue.
- Examples and tests now use project-relative paths and explicit `.js` import specifiers to ensure Node resolves modules correctly.

See also

- `CHANGELOG.md` for recent changes.
- `examples/` for runnable usage.
- `tests/` for automated checks used by CI.
