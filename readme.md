# xcfreader

Parses files generated by GIMP (.xcf) and exposes a TypeScript/JavaScript API to read metadata, layers and render images.

## Highlights

- **TypeScript source**: source files in `src/` are TypeScript (`.ts`); compiled to `dist/` with `tsc`.
- **Full type safety**: strict TypeScript with types for `Color`, `ColorRGBA`, `XCFParser`, `GimpLayer`, `XCFImage`.
- **Native ESM**: `package.json` sets `type: "module"` and `main` points to `dist/gimpparser.js`.
- **Promise-based API**: `XCFParser.parseFileAsync(path)` returns a `Promise`; examples and tests use `async`/`await`.
- **Examples and tests**: in `src/examples/` and `src/tests/`, runnable with `npm run build` followed by `node dist/examples/*.js`, or use convenience scripts `npm run single|multi|map|text|test`.

## What it does

- Parse a GIMP XCF file and expose image width/height and layer metadata.
- Provide per-layer rendering via a small `XCFImage` wrapper around `pngjs`.
- Support RGB/RGBA raster images (indexed/grayscale/text/path support is limited or TODO).

## Quick start

Install dependencies:

```bash
npm install
```

Build TypeScript:

```bash
npm run build
```

Run examples (auto-builds first):

```bash
npm run single
npm run multi
npm run map
npm run text
npm run empty
```

Run tests (auto-builds first):

```bash
npm test
```

Watch mode (continuous TypeScript compilation):

```bash
npm run watch
```

## Usage (programmatic)

Import and use the parser (ESM):

```ts
import { XCFParser } from "./dist/gimpparser.js";

// Using async/await
const parser = await XCFParser.parseFileAsync("./examples/single.xcf");
console.log(parser.width, parser.height);
console.log("layers:", parser.layers.length);
const image = parser.createImage(); // returns an XCFImage with flattened visible layers
await image.writeImage("./examples/output/flattened.png");
## Usage (TypeScript)

```typescript
import { XCFParser } from "./dist/gimpparser.js";

async function main() {
  const parser = await XCFParser.parseFileAsync("./examples/single.xcf");
  const image = parser.createImage();
  await image.writeImage("./examples/output/flattened.png");
}

main();
```

// Or using callbacks (legacy)
XCFParser.parseFile("./examples/single.xcf", (err, parser) => {
  if (err) throw err;
  const image = parser.createImage();
  image.writeImage("./examples/output/flattened.png");
});
```

## API notes

- `XCFParser.parseFileAsync(path)` — parse an XCF file asynchronously; returns `Promise<XCFParser>`.
- `XCFParser.parseFile(path, callback)` — parse an XCF file with callback (legacy); calls `parseFileAsync` internally.
- `parser.width`, `parser.height` — numeric image dimensions.
- `parser.layers` — array of `GimpLayer` objects. `GimpLayer` exposes `.name`, `.width`, `.height`, `.x`, `.y`, `.isVisible`, `.isGroup`, `.opacity`, and `.parasites`.
- `GimpLayer.makeImage(image?, useOffset?)` — renders the layer into an `XCFImage` instance. If `image` is omitted, returns a new `XCFImage` sized appropriately.
- `parser.createImage()` — returns an `XCFImage` with all visible layers flattened (uses layer offsets).

## About `XCFImage`

`XCFImage` is a thin wrapper around `pngjs` and implements `setAt(x,y,colour)` and `getAt(x,y)` where `colour` is `{red, green, blue, alpha}`. Example usage and tests expect this contract.

## Notes for contributors

- **Edit source in `src/` only**. TypeScript files are compiled to `dist/` by `npm run build`.
- **Do not edit `dist/`** except to inspect compiled output for debugging.
- Full TypeScript strict mode; be explicit with types or use `as any` sparingly.
- Many parsers are built with `binary-parser`; preserve existing assertions and formatters unless fixing a specific format issue.
- Examples and tests use project-relative paths and explicit `.js` import specifiers to ensure Node ESM resolution.

## See also

- `CHANGELOG.md` for recent changes (TypeScript migration, Promise API).
- `.github/copilot-instructions.md` for AI agent guidance on architecture and common edits.
- `examples/` for runnable TypeScript/JS examples.
- `tests/` for automated test suite.
