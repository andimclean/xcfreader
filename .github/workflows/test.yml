name: CI

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
      - uses: actions/checkout@v6

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Run xcfreader tests
        run: npm run test:xcfreader

      - name: Run examples
        run: |
          npm run single &
          sleep 2
          kill %1 2>/dev/null || true

      - name: Run xcfreader coverage
        run: npm run coverage

      - name: Calculate combined coverage
        run: node calculate-total-coverage.mjs

      - name: Run benchmark
        run: |
          npm run benchmark > benchmark-output.txt
          echo "Benchmark results:" && cat benchmark-output.txt
          echo "::notice ::Benchmark results are for information only and do not affect CI status."

      - name: Check performance regression
        run: |
          cd packages/xcfreader
          if [ -f benchmark-baseline.json ]; then
            npm run benchmark:check || echo "::warning ::Performance regression detected. Review benchmark results."
          else
            echo "::notice ::No baseline found. Run 'npm run benchmark:baseline' to create one."
          fi

      - name: Enforce minimum coverage
        run: |
          COVERAGE=$(node -p "require('./coverage-combined.json').total.lines.pct")
          echo "Combined line coverage: $COVERAGE%"
          MIN=80
          WARN=85
          if [ "$(echo "$COVERAGE < $MIN" | bc)" -eq 1 ]; then
            echo "::error ::Combined test coverage ($COVERAGE%) is below minimum threshold ($MIN%)"
            exit 1
          elif [ "$(echo "$COVERAGE < $WARN" | bc)" -eq 1 ]; then
            echo "::warning ::Combined test coverage ($COVERAGE%) is below warning threshold ($WARN%)"
          else
            echo "::notice ::Combined coverage ($COVERAGE%) meets quality standards âœ…"
          fi

  lint-commits:
    name: Lint Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate commit messages
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

  validate-packages:
    name: Validate Package Exports
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Validate package exports
        run: npm run validate:exports

  bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Check bundle sizes
        run: npm run bundle-size:ci
